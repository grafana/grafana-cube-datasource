services:
  grafana:
    extends:
      file: .config/docker-compose-base.yaml
      service: grafana
    container_name: 'grafana-itself'
    build:
      args:
        grafana_version: ${GRAFANA_VERSION:-12.2.0-17253726931}
        grafana_image: ${GRAFANA_IMAGE:-grafana}
    environment:
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /etc/grafana/provisioning/dashboards/cube-datasource-poc.json
      GF_FEATURE_TOGGLES_ENABLE: 'tableNextGen,queryLibrary,sqlExpressions,dashboardDsAdHocFiltering,adhocFiltersInTooltips'
    depends_on:
      - cube

  cube:
    image: cubejs/cube:latest@sha256:bcf2f3c5183a36a15b9c7fbe0ed21e50aa0caeabb81ff26b5189f619a29cd11f
    ports:
      - 4000:4000
      - 15432:15432
    volumes:
      - ./dev-environment/cube:/cube/conf
    depends_on:
      - postgres

  postgres:
    image: postgres:18@sha256:fdd16e63f6c8ab50d422e4896b0d43d45fb72aa08bd33e4f5bda89bc4fbce98d
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: jaffle_shop
    ports:
      - '5432:5432'
    volumes:
      - ./dev-environment/data/seeds/:/data/seeds/
      - ./dev-environment/data/migrations/init.sql:/docker-entrypoint-initdb.d/init.sql
    # Enable SQL queries in the logs (minimal output)
    command:
      [
        'postgres',
        '-c',
        'log_statement=all',
        '-c',
        'log_line_prefix=',
        '-c',
        'log_duration=off',
        '-c',
        'log_parameter_max_length=0',
      ]
